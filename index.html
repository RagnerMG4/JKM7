<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>متابعة سكر الدم</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Cairo:700,400&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', Arial, sans-serif;
      background-color: #f0f4f8;
      direction: rtl;
      padding: 0;
      margin: 0;
    }

    .container {
      max-width: 850px;
      margin: 40px auto;
      background: #ffffff;
      padding: 40px 24px 32px 24px;
      border-radius: 18px;
      box-shadow: 0 0 24px rgba(0,0,0,0.13);
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 2.6rem;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    .instructions {
      text-align: center;
      font-size: 1.25rem;
      color: #555;
      margin-bottom: 30px;
      background: #eaf6ff;
      padding: 12px 0;
      border-radius: 8px;
    }

    label {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 10px;
      display: block;
      color: #2c3e50;
      letter-spacing: 0.5px;
    }

    input[type="number"] {
      width: 100%;
      padding: 18px;
      font-size: 1.5rem;
      border: 2px solid #b3c6e0;
      border-radius: 10px;
      margin-bottom: 24px;
      background: #f8fbff;
      transition: border 0.2s;
      box-sizing: border-box;
    }
    input[type="number"]:focus {
      border: 2.5px solid #2980b9;
      outline: none;
      background: #eaf6ff;
    }

    .btn-group {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 24px;
    }

    .btn {
      flex: 1;
      padding: 18px 0;
      font-size: 1.3rem;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(44,62,80,0.07);
    }

    .btn-add {
      background-color: #3498db;
    }
    .btn-add:hover {
      background-color: #217dbb;
    }
    .btn-pdf {
      background-color: #27ae60;
    }
    .btn-pdf:hover {
      background-color: #1e874a;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 18px;
      border-radius: 10px;
      box-shadow: 0 1px 8px rgba(44,62,80,0.06);
      background: #f8fbff;
      padding: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.15rem;
      min-width: 600px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 16px 10px;
      border: 1px solid #e0e6ed;
      text-align: center;
    }

    th {
      background-color: #2980b9;
      color: white;
      font-size: 1.15rem;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .note {
      font-weight: bold;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .note-low {
      color: #e74c3c;
    }
    .note-normal {
      color: #27ae60;
    }
    .note-high {
      color: #e67e22;
    }

    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      justify-content: center;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px 2vw 18px 2vw;
      }
      h1 {
        font-size: 2rem;
      }
      .instructions {
        font-size: 1rem;
      }
      input[type="number"] {
        font-size: 1.1rem;
        padding: 12px;
      }
      .btn {
        font-size: 1rem;
        padding: 12px 0;
      }
      table {
        font-size: 0.95rem;
        min-width: 400px;
      }
      th, td {
        padding: 10px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>متابعة سكر الدم</h1>
    <div class="instructions">
      أدخل قياس السكر في الحقل أدناه واضغط <b>إضافة</b>.<br>
      يمكنك حذف أي سجل أو تحميل جميع السجلات كملف PDF.<br>
      <span style="color:#e74c3c;font-weight:bold;">ملاحظة:</span> هذا البرنامج سهل الاستخدام ومناسب لكبار السن.
    </div>

    <label for="reading">قياس السكر (ملغم/ديسيلتر):</label>
    <input type="number" id="reading" placeholder="ادخل قيمة قياس السكر" required autofocus />

    <div class="btn-group">
      <button class="btn btn-add" onclick="addRecord()">
        <span aria-hidden="true">➕</span> إضافة
      </button>
      <button class="btn btn-pdf" onclick="downloadPDF()">
        <span aria-hidden="true">⬇️</span> تحميل كـ PDF
      </button>
    </div>

    <div class="table-wrapper" id="tableContainer">
      <table id="recordsTable">
        <thead>
          <tr>
            <th>القياس</th>
            <th>الملاحظة</th>
            <th>التاريخ والوقت</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let records = [];

    // تحميل البيانات المحفوظة عند فتح الصفحة
    window.onload = function () {
      const saved = localStorage.getItem('bloodSugarRecords');
      if (saved) {
        records = JSON.parse(saved);
        updateTable();
      }
      // تركيز تلقائي على الحقل
      document.getElementById('reading').focus();
    };

    function addRecord() {
      const readingInput = document.getElementById('reading');
      const reading = parseFloat(readingInput.value);
      if (isNaN(reading)) {
        alert('الرجاء إدخال قيمة صحيحة لقياس السكر');
        readingInput.focus();
        return;
      }

      const now = new Date();
      const date = now.toLocaleDateString('ar-EG');
      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'مساءً' : 'صباحاً';
      hours = hours % 12 || 12;
      const time = `${hours}:${minutes} ${ampm}`;

      let note = '';
      let noteClass = '';
      let noteIcon = '';
      if (reading < 70) {
        note = 'منخفض';
        noteClass = 'note-low';
        noteIcon = '🔻';
      } else if (reading <= 140) {
        note = 'طبيعي';
        noteClass = 'note-normal';
        noteIcon = '✅';
      } else {
        note = 'مرتفع';
        noteClass = 'note-high';
        noteIcon = '🔺';
      }

      records.push({ reading, note, noteClass, noteIcon, date, time });
      saveRecords();
      updateTable();
      readingInput.value = '';
      readingInput.focus();
    }

    function saveRecords() {
      localStorage.setItem('bloodSugarRecords', JSON.stringify(records));
    }

    function deleteRecord(index) {
      if (confirm('هل أنت متأكد من حذف هذا السطر؟')) {
        records.splice(index, 1);
        saveRecords();
        updateTable();
      }
    }

    function updateTable() {
      const tbody = document.getElementById('recordsTable').querySelector('tbody');
      tbody.innerHTML = '';
      if (records.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 4;
        cell.textContent = 'لا توجد سجلات بعد.';
        cell.style.color = '#888';
        cell.style.fontWeight = 'bold';
        cell.style.fontSize = '1.1rem';
        cell.style.background = '#f8fbff';
        cell.style.textAlign = 'center';
        return;
      }
      records.forEach((record, index) => {
        const row = tbody.insertRow();

        row.insertCell().textContent = record.reading;

        const noteCell = row.insertCell();
        noteCell.className = `note ${record.noteClass}`;
        noteCell.innerHTML = `<span aria-hidden="true">${record.noteIcon}</span> ${record.note}`;

        row.insertCell().textContent = `${record.date} - ${record.time}`;

        const deleteCell = row.insertCell();
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<span aria-hidden="true">🗑️</span> حذف';
        deleteBtn.className = 'delete-btn';
        deleteBtn.onclick = () => deleteRecord(index);
        deleteCell.appendChild(deleteBtn);
      });
    }

    function downloadPDF() {
      // إخفاء عمود الحذف مؤقتًا
      document.querySelectorAll('th:last-child, td:last-child, .delete-btn').forEach(el => {
        el.style.display = 'none';
      });

      const element = document.getElementById('tableContainer');
      const opt = {
        margin: 0.5,
        filename: 'blood_sugar_report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(element).save().then(() => {
        // إعادة إظهار العمود بعد التحميل
        document.querySelectorAll('th:last-child, td:last-child, .delete-btn').forEach(el => {
          el.style.display = '';
        });
      });
    }
  </script>
</body>
</html>
